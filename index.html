<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bitcoin Realized Price (Auto-Updating)</title>

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #111827;
      color: #e5e7eb;
    }
    h1 {
      font-size: 28px;
      margin: 20px;
    }
    #chart {
      width: 100%;
      height: 90vh;
    }
    #error {
      margin: 20px;
      color: #f87171;
      font-size: 16px;
    }
  </style>
</head>

<body>
  <h1>Bitcoin Realized Price (Auto-Updating)</h1>
  <div id="error"></div>
  <div id="chart"></div>

  <script>
    async function loadChart() {
      const errorDiv = document.getElementById('error');

      function showError(msg) {
        if (errorDiv) {
          errorDiv.textContent = 'Error loading data: ' + msg;
        } else {
          console.error(msg);
        }
      }

      try {
        const response = await fetch('data/realized-price.json?cache=' + Date.now());
        if (!response.ok) {
          throw new Error('HTTP ' + response.status + ' ' + response.statusText);
        }

        const json = await response.json();

        // JSON is an array of { date, value }
        let rows = Array.isArray(json) ? json : null;

        // Fallback if wrapped in an object
        if (!rows && json && typeof json === 'object') {
          const arrKey = Object.keys(json).find(k => Array.isArray(json[k]));
          if (arrKey) rows = json[arrKey];
        }

        if (!Array.isArray(rows)) {
          throw new Error('Unexpected JSON structure');
        }

        const dates = [];
        const prices = [];

        for (const row of rows) {
          const dateStr = row.date;
          let value = row.value;

          if (!dateStr || value === undefined || value === null) continue;

          value = Number(value);
          if (Number.isNaN(value)) continue;

          dates.push(dateStr);
          prices.push(value);
        }

        if (!dates.length) {
          throw new Error(
            'No valid data points found. Parsed ' +
            rows.length +
            ' rows but 0 usable points.'
          );
        }

        const trace = {
          x: dates,
          y: prices,
          mode: 'lines',
          line: { width: 2 },
          name: 'Realized Price'
        };

        const layout = {
          title: {
            text: 'Bitcoin Realized Price (Auto-Updating)',
            font: { size: 24 }
          },
          xaxis: { title: 'Date', type: 'date' },
          yaxis: { title: 'Realized Price (USD)' },
          margin: { l: 60, r: 20, t: 60, b: 60 },
          paper_bgcolor: '#111827',
          plot_bgcolor: '#111827',
          font: { color: '#e5e7eb' }
        };

        Plotly.newPlot('chart', [trace], layout, { responsive: true });
        errorDiv.textContent = '';

      } catch (err) {
        showError(err.message || String(err));
      }
    }

    document.addEventListener('DOMContentLoaded', loadChart);
  </script>
</body>
</html>
